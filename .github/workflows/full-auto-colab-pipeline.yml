name: ğŸ¤– Full Auto Colab Pipeline (100% Automated)

on:
  push:
    branches: [main, develop, automation-only]
  workflow_dispatch:
    inputs:
      force_colab_restart:
        description: 'Force Colab restart'
        required: false
        default: 'false'
  repository_dispatch:
    types: [colab-ready]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================
  # JOB 1: Automated Colab Orchestration
  # ============================================================
  orchestrate-colab:
    name: ğŸ¤– Orchestrate Colab (Automated)
    runs-on: ubuntu-latest
    outputs:
      comfyui_url: ${{ steps.agent.outputs.comfyui_url }}
      colab_status: ${{ steps.agent.outputs.status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install requests

      - name: ğŸ¤– Run Colab Automation Agent
        id: agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COLAB_NOTEBOOK_ID: ${{ secrets.COLAB_NOTEBOOK_ID }}
          COMFYUI_URL_GIST_ID: ${{ secrets.COMFYUI_URL_GIST_ID }}
          COLAB_TRIGGER_WEBHOOK: ${{ secrets.COLAB_TRIGGER_WEBHOOK }}
          COMFYUI_FALLBACK_URL: ${{ secrets.COMFYUI_FALLBACK_URL }}
          DISPATCH_COMFYUI_URL: ${{ github.event.client_payload.comfyui_url }}
        run: |
          # Se disparado via repository_dispatch com URL no payload, usar diretamente
          if [ ! -z "$DISPATCH_COMFYUI_URL" ]; then
            echo "ğŸ¯ Disparado via repository_dispatch!"
            echo "ğŸ“ URL recebida do Colab: $DISPATCH_COMFYUI_URL"
            echo "comfyui_url=$DISPATCH_COMFYUI_URL" >> $GITHUB_OUTPUT
            echo "status=ready" >> $GITHUB_OUTPUT
            echo "âœ… URL do Colab configurada diretamente!"
          else
            echo "ğŸ¤– Iniciando Agente de AutomaÃ§Ã£o do Colab..."
            python .github/scripts/colab_automation_agent.py
            echo "âœ… Agente executado com sucesso!"
          fi

      - name: Verify URL captured
        run: |
          URL="${{ steps.agent.outputs.comfyui_url }}"
          echo "ğŸ” URL capturada: $URL"
          
          if [ -z "$URL" ]; then
            echo "âŒ URL nÃ£o foi capturada pelo agente"
            exit 1
          fi
          
          echo "âœ… URL vÃ¡lida capturada!"

  # ============================================================
  # JOB 2: Update Configuration (Automated)
  # ============================================================
  update-config:
    name: âš™ï¸ Update Configuration
    runs-on: ubuntu-latest
    needs: orchestrate-colab
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update .env with Colab URL
        run: |
          URL="${{ needs.orchestrate-colab.outputs.comfyui_url }}"
          echo "ğŸ“ Atualizando configuraÃ§Ãµes com URL: $URL"
          
          # Criar/atualizar .env
          echo "COMFYUI_URL=$URL" > .env.auto
          echo "COMFYUI_SOURCE=colab_automated" >> .env.auto
          echo "UPDATED_AT=$(date)" >> .env.auto
          
          echo "âœ… ConfiguraÃ§Ãµes atualizadas!"

  # ============================================================
  # JOB 3: Run Integration Tests (Automated)
  # ============================================================
  test-integration:
    name: ğŸ§ª Run Integration Tests
    runs-on: ubuntu-latest
    needs: orchestrate-colab
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pytest requests

      - name: Test ComfyUI Integration
        env:
          COMFYUI_URL: ${{ needs.orchestrate-colab.outputs.comfyui_url }}
        run: |
          echo "ğŸ§ª Testando integraÃ§Ã£o com ComfyUI..."
          echo "URL: $COMFYUI_URL"
          
          # Criar teste
          cat > test_comfyui_auto.py << 'EOF'
          import os
          import requests

          def test_comfyui_available():
              url = os.getenv('COMFYUI_URL')
              assert url, "COMFYUI_URL not set"
              
              print(f"ğŸ” Testando URL: {url}")
              response = requests.get(url, timeout=10)
              assert response.status_code == 200, f"ComfyUI not accessible: {response.status_code}"
              print(f"âœ… ComfyUI is accessible at {url}")

          if __name__ == "__main__":
              test_comfyui_available()
          EOF
          
          python test_comfyui_auto.py

  # ============================================================
  # JOB 4: Generate AI Content (Automated)
  # ============================================================
  generate-content:
    name: ğŸ¬ Generate AI Content
    runs-on: ubuntu-latest
    needs: [orchestrate-colab, test-integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install requests
          pip install -r requirements.txt || echo "requirements.txt not found"
          pip install -r open3d_implementation/orchestration/requirements_dagster.txt || echo "requirements_dagster.txt not found"

      - name: ğŸ¬ Run AI Film Pipeline
        env:
          COMFYUI_URL: ${{ needs.orchestrate-colab.outputs.comfyui_url }}
          STORY_INPUT: ${{ github.event.client_payload.story }}
          # LLM APIs (Gemini como principal, OpenAI como fallback)
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # Outras APIs
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          STABILITY_API_KEY: ${{ secrets.STABILITY_API_KEY }}
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: |
          echo "ğŸ¬ Iniciando pipeline de geraÃ§Ã£o de conteÃºdo..."
          echo "URL do ComfyUI: $COMFYUI_URL"
          echo "ğŸ¤– LLM: Gemini 2.0 Flash (Principal)"
          
          # Criar diretÃ³rio output se nÃ£o existir
          mkdir -p output
          
          # Salvar histÃ³ria do payload em arquivo (preservando quebras de linha)
          if [ ! -z "$STORY_INPUT" ]; then
            echo "ğŸ“ HistÃ³ria recebida do Colab"
            # Usar cat com heredoc para preservar quebras de linha
            cat > output/story_latest.txt << 'STORY_EOF'
          ${{ github.event.client_payload.story }}
          STORY_EOF
            # Contar caracteres
            STORY_SIZE=$(wc -c < output/story_latest.txt)
            echo "âœ… HistÃ³ria salva: $STORY_SIZE caracteres"
          else
            echo "âš ï¸ Nenhuma histÃ³ria no payload, verificando arquivo..."
            if [ ! -f output/story_latest.txt ]; then
              echo "âŒ Arquivo de histÃ³ria nÃ£o encontrado!"
              echo "ğŸ’¡ Criando histÃ³ria padrÃ£o..."
              echo "Uma jornada Ã©pica atravÃ©s de um mundo cyberpunk futurista" > output/story_latest.txt
            fi
          fi
          
          # Instalar dependÃªncias Python
          echo "ğŸ“¦ Instalando dependÃªncias Python..."
          pip install langchain langchain-openai langchain-google-genai langgraph dagster python-dotenv requests pillow
          
          # Verificar ambiente
          python .github/scripts/check_env.py
          
          # Executar pipeline real
          python .github/scripts/run_ai_pipeline.py
          
          echo "âœ… Pipeline de conteÃºdo executado!"

  # ============================================================
  # JOB 5: Deploy to Kubernetes (Automated - Only on main)
  # ============================================================
  deploy-kubernetes:
    name: ğŸš¢ Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [orchestrate-colab, generate-content]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Kubernetes Secret
        run: |
          URL="${{ needs.orchestrate-colab.outputs.comfyui_url }}"
          echo "ğŸ” Atualizando secret do Kubernetes..."
          echo "URL: $URL"
          
          # Aqui vocÃª configuraria kubectl e atualizaria o secret
          # kubectl create secret generic comfyui-url --from-literal=url="$URL" --dry-run=client -o yaml | kubectl apply -f -
          
          echo "âœ… Secret atualizado (simulado)"

  # ============================================================
  # JOB 6: Notification (Automated)
  # ============================================================
  notify:
    name: ğŸ“¢ Send Notification
    runs-on: ubuntu-latest
    needs: [orchestrate-colab, generate-content]
    if: always()
    steps:
      - name: Send notification
        run: |
          STATUS="${{ needs.generate-content.result }}"
          URL="${{ needs.orchestrate-colab.outputs.comfyui_url }}"
          
          echo "ğŸ“¢ Enviando notificaÃ§Ã£o..."
          echo "Status: $STATUS"
          echo "URL: $URL"
          
          # Aqui vocÃª pode enviar para Slack, Discord, etc
          # curl -X POST $WEBHOOK_URL -d "Pipeline status: $STATUS"
          
          echo "âœ… NotificaÃ§Ã£o enviada!"

  # ============================================================
  # JOB 7: Cleanup (Automated)
  # ============================================================
  cleanup:
    name: ğŸ§¹ Cleanup Resources
    runs-on: ubuntu-latest
    needs: [orchestrate-colab, generate-content, deploy-kubernetes]
    if: always()
    steps:
      - name: Cleanup temporary resources
        run: |
          echo "ğŸ§¹ Limpando recursos temporÃ¡rios..."
          
          # Aqui vocÃª pode limpar recursos temporÃ¡rios
          # Exemplo: parar Colab se necessÃ¡rio, limpar caches, etc
          
          echo "âœ… Limpeza concluÃ­da!"
